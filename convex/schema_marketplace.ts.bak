import { defineSchema, defineTable } from "convex/server";
import { v } from "convex/values";

/**
 * Simplified marketplace schema for PPR Academy
 * This new schema reduces complexity from 60+ tables to ~15 core tables
 * while maintaining all essential functionality for a creator marketplace
 */

export default defineSchema({
  // ==================== CORE USER & CREATOR ====================
  
  // Simplified user model
  users: defineTable({
    // Essential fields
    email: v.string(),
    name: v.optional(v.string()),
    imageUrl: v.optional(v.string()),
    clerkId: v.string(),
    
    // Creator fields
    isCreator: v.optional(v.boolean()),
    username: v.optional(v.string()), // Unique creator username
    bio: v.optional(v.string()),
    
    // Social links (simplified)
    socialLinks: v.optional(v.object({
      website: v.optional(v.string()),
      twitter: v.optional(v.string()),
      instagram: v.optional(v.string()),
      youtube: v.optional(v.string()),
      tiktok: v.optional(v.string()),
    })),
    
    // Stripe (for creators)
    stripeConnectAccountId: v.optional(v.string()),
    stripeConnectComplete: v.optional(v.boolean()),
  })
  .index("by_email", ["email"])
  .index("by_clerkId", ["clerkId"])
  .index("by_username", ["username"])
  .index("by_isCreator", ["isCreator"]),

  // Creator storefronts
  creatorStores: defineTable({
    userId: v.id("users"),
    
    // Store info
    name: v.string(),
    slug: v.string(), // URL-friendly identifier
    description: v.optional(v.string()),
    bannerUrl: v.optional(v.string()),
    logoUrl: v.optional(v.string()),
    
    // Customization
    theme: v.optional(v.object({
      primaryColor: v.optional(v.string()),
      secondaryColor: v.optional(v.string()),
      fontFamily: v.optional(v.string()),
      layout: v.optional(v.string()),
    })),
    
    // Analytics
    metrics: v.optional(v.object({
      views: v.optional(v.number()),
      subscribers: v.optional(v.number()),
      totalSales: v.optional(v.number()),
      totalRevenue: v.optional(v.number()),
    })),
    
    // Status
    isActive: v.optional(v.boolean()),
    featured: v.optional(v.boolean()),
    verifiedCreator: v.optional(v.boolean()),
  })
  .index("by_userId", ["userId"])
  .index("by_slug", ["slug"])
  .index("by_isActive", ["isActive"])
  .index("by_featured", ["featured"]),

  // ==================== PRODUCTS & CONTENT ====================
  
  // Unified product model
  products: defineTable({
    creatorId: v.id("users"),
    storeId: v.id("creatorStores"),
    
    // Basic info
    type: v.union(
      v.literal("course"),
      v.literal("coaching"),
      v.literal("digital_product"),
      v.literal("consultation"),
      v.literal("membership"),
      v.literal("preset_pack"),
      v.literal("sample_pack"),
      v.literal("template")
    ),
    title: v.string(),
    description: v.optional(v.string()),
    
    // Pricing
    price: v.number(),
    currency: v.optional(v.string()), // Default USD
    compareAtPrice: v.optional(v.number()), // For showing discounts
    
    // Access control
    accessType: v.union(
      v.literal("one_time"),
      v.literal("subscription"),
      v.literal("free")
    ),
    subscriptionTier: v.optional(v.string()), // For subscription products
    
    // Content (flexible structure)
    content: v.optional(v.any()), // JSON data for modules, files, etc.
    
    // Media
    thumbnailUrl: v.optional(v.string()),
    previewUrl: v.optional(v.string()),
    downloadUrl: v.optional(v.string()), // For digital products
    
    // Status
    isPublished: v.optional(v.boolean()),
    isFeatured: v.optional(v.boolean()),
    
    // SEO
    slug: v.optional(v.string()),
    seoTitle: v.optional(v.string()),
    seoDescription: v.optional(v.string()),
    
    // Analytics
    metrics: v.optional(v.object({
      views: v.optional(v.number()),
      sales: v.optional(v.number()),
      rating: v.optional(v.number()),
      reviewCount: v.optional(v.number()),
    })),
  })
  .index("by_creatorId", ["creatorId"])
  .index("by_storeId", ["storeId"])
  .index("by_type", ["type"])
  .index("by_isPublished", ["isPublished"])
  .index("by_slug", ["slug"])
  .index("by_creatorId_published", ["creatorId", "isPublished"])
  .index("by_type_published", ["type", "isPublished"])
  .index("by_featured", ["isFeatured"])
  .searchIndex("search_products", {
    searchField: "title",
    filterFields: ["type", "isPublished", "creatorId"]
  }),

  // ==================== SUBSCRIPTIONS & PURCHASES ====================
  
  // Creator subscription tiers
  subscriptionTiers: defineTable({
    creatorId: v.id("users"),
    storeId: v.id("creatorStores"),
    
    // Tier details
    name: v.string(), // Basic, Pro, Premium
    description: v.optional(v.string()),
    price: v.number(),
    interval: v.union(v.literal("monthly"), v.literal("yearly")),
    
    // Benefits
    benefits: v.optional(v.array(v.string())),
    
    // Access to products
    includedProductIds: v.optional(v.array(v.id("products"))),
    
    // Stripe
    stripePriceId: v.optional(v.string()),
    
    // Status
    isActive: v.optional(v.boolean()),
    subscriberCount: v.optional(v.number()),
  })
  .index("by_creatorId", ["creatorId"])
  .index("by_storeId", ["storeId"])
  .index("by_isActive", ["isActive"]),

  // User subscriptions to creators
  userSubscriptions: defineTable({
    userId: v.id("users"),
    creatorId: v.id("users"),
    tierId: v.id("subscriptionTiers"),
    
    // Subscription details
    status: v.union(
      v.literal("active"),
      v.literal("past_due"),
      v.literal("canceled"),
      v.literal("incomplete"),
      v.literal("trialing")
    ),
    
    // Billing
    currentPeriodStart: v.number(),
    currentPeriodEnd: v.number(),
    cancelAtPeriodEnd: v.optional(v.boolean()),
    
    // Stripe
    stripeSubscriptionId: v.optional(v.string()),
    stripeCustomerId: v.optional(v.string()),
  })
  .index("by_userId", ["userId"])
  .index("by_creatorId", ["creatorId"])
  .index("by_status", ["status"])
  .index("by_userId_creatorId", ["userId", "creatorId"]),

  // Purchase records
  purchases: defineTable({
    userId: v.id("users"),
    productId: v.id("products"),
    creatorId: v.id("users"),
    
    // Payment details
    amount: v.number(),
    currency: v.optional(v.string()),
    
    // Status
    status: v.union(
      v.literal("pending"),
      v.literal("completed"),
      v.literal("failed"),
      v.literal("refunded")
    ),
    
    // Stripe
    stripePaymentIntentId: v.optional(v.string()),
    stripeRefundId: v.optional(v.string()),
    
    // Timestamps
    completedAt: v.optional(v.number()),
    refundedAt: v.optional(v.number()),
  })
  .index("by_userId", ["userId"])
  .index("by_productId", ["productId"])
  .index("by_creatorId", ["creatorId"])
  .index("by_status", ["status"]),

  // ==================== REVIEWS & RATINGS ====================
  
  reviews: defineTable({
    userId: v.id("users"),
    productId: v.id("products"),
    
    rating: v.number(), // 1-5
    comment: v.optional(v.string()),
    
    // Moderation
    isApproved: v.optional(v.boolean()),
    helpfulCount: v.optional(v.number()),
  })
  .index("by_productId", ["productId"])
  .index("by_userId", ["userId"])
  .index("by_rating", ["rating"])
  .index("by_isApproved", ["isApproved"]),

  // ==================== CREATOR EARNINGS & PAYOUTS ====================
  
  earnings: defineTable({
    creatorId: v.id("users"),
    
    // Earning details
    type: v.union(
      v.literal("product_sale"),
      v.literal("subscription"),
      v.literal("tip"),
      v.literal("affiliate")
    ),
    amount: v.number(),
    platformFee: v.number(), // 10% platform fee
    netAmount: v.number(), // Amount after fee
    currency: v.optional(v.string()),
    
    // Reference
    referenceType: v.optional(v.string()), // purchase, subscription, etc.
    referenceId: v.optional(v.string()),
    description: v.optional(v.string()),
  })
  .index("by_creatorId", ["creatorId"])
  .index("by_type", ["type"]),

  payouts: defineTable({
    creatorId: v.id("users"),
    
    // Payout details
    amount: v.number(),
    currency: v.optional(v.string()),
    method: v.optional(v.string()), // stripe_connect, paypal, etc.
    
    // Status
    status: v.union(
      v.literal("pending"),
      v.literal("processing"),
      v.literal("completed"),
      v.literal("failed")
    ),
    
    // Stripe
    stripePayoutId: v.optional(v.string()),
    
    // Timestamps
    processedAt: v.optional(v.number()),
    failureReason: v.optional(v.string()),
  })
  .index("by_creatorId", ["creatorId"])
  .index("by_status", ["status"]),

  // ==================== SIMPLIFIED EMAIL & MARKETING ====================
  
  // Email subscribers (simplified)
  emailSubscribers: defineTable({
    email: v.string(),
    name: v.optional(v.string()),
    storeId: v.optional(v.id("creatorStores")), // Subscribe to specific creator
    
    // Preferences
    marketingOptIn: v.optional(v.boolean()),
    creatorUpdates: v.optional(v.boolean()),
    
    // Source tracking
    source: v.optional(v.string()),
    referrer: v.optional(v.string()),
  })
  .index("by_email", ["email"])
  .index("by_storeId", ["storeId"]),

  // Simple email campaigns
  emailCampaigns: defineTable({
    creatorId: v.id("users"),
    storeId: v.id("creatorStores"),
    
    // Campaign details
    name: v.string(),
    subject: v.string(),
    content: v.string(), // HTML content
    
    // Status
    status: v.union(
      v.literal("draft"),
      v.literal("scheduled"),
      v.literal("sent"),
      v.literal("failed")
    ),
    
    // Scheduling
    scheduledAt: v.optional(v.number()),
    sentAt: v.optional(v.number()),
    
    // Simple metrics
    metrics: v.optional(v.object({
      recipientCount: v.optional(v.number()),
      openCount: v.optional(v.number()),
      clickCount: v.optional(v.number()),
    })),
  })
  .index("by_creatorId", ["creatorId"])
  .index("by_storeId", ["storeId"])
  .index("by_status", ["status"]),

  // ==================== ANALYTICS & METRICS ====================
  
  // Simplified analytics events
  analyticsEvents: defineTable({
    // Event details
    eventType: v.string(), // page_view, product_view, purchase, etc.
    eventData: v.optional(v.any()), // Flexible data
    
    // Context
    userId: v.optional(v.id("users")),
    creatorId: v.optional(v.id("users")),
    storeId: v.optional(v.id("creatorStores")),
    productId: v.optional(v.id("products")),
    
    // Session info
    sessionId: v.optional(v.string()),
    ipAddress: v.optional(v.string()),
    userAgent: v.optional(v.string()),
    referrer: v.optional(v.string()),
  })
  .index("by_eventType", ["eventType"])
  .index("by_userId", ["userId"])
  .index("by_creatorId", ["creatorId"])
  .index("by_storeId", ["storeId"]),

  // ==================== NOTIFICATIONS ====================
  
  notifications: defineTable({
    userId: v.id("users"),
    
    // Notification details
    type: v.string(), // new_sale, new_subscriber, payout_complete, etc.
    title: v.string(),
    message: v.string(),
    
    // Status
    isRead: v.optional(v.boolean()),
    
    // Action
    actionUrl: v.optional(v.string()),
    actionLabel: v.optional(v.string()),
    
    // Reference
    referenceType: v.optional(v.string()),
    referenceId: v.optional(v.string()),
  })
  .index("by_userId", ["userId"])
  .index("by_isRead", ["isRead"]),
});