# Plugin Directory Migration Guide
## Prisma/Planetscale ‚Üí Convex

This guide will help you migrate your existing plugin data from Prisma/Planetscale to Convex.

---

## üìã Pre-Migration Checklist

‚úÖ Convex schema has been added to `convex/schema.ts`  
‚úÖ Plugin queries and mutations are created in `convex/plugins.ts`  
‚úÖ Admin plugin management page is at `/admin/plugins`  
‚úÖ Marketplace plugins page is at `/marketplace/plugins`

---

## üóÇÔ∏è Schema Mapping

### Prisma ‚Üí Convex Table Mapping

| Prisma Model | Convex Table | Notes |
|--------------|--------------|-------|
| `PluginType` | `pluginTypes` | Main plugin types (Effect, Instrument, Studio Tool) |
| `PluginEffectCategory` | `pluginEffectCategories` | Effect-specific categories |
| `PluginInstrumentCategory` | `pluginInstrumentCategories` | Instrument-specific categories |
| `PluginStudioToolCategory` | `pluginStudioToolCategories` | Studio tool categories |
| `PluginCategory` | `pluginCategories` | General plugin categories |
| `Plugin` | `plugins` | Main plugin records |

### Field Mapping: Plugin

| Prisma Field | Convex Field | Type Conversion |
|--------------|--------------|-----------------|
| `id` (UUID) | `_id` | Auto-generated by Convex |
| `name` | `name` | String (no change) |
| `slug` | `slug` | Optional String |
| `author` | `author` | Optional String |
| `description` | `description` | Optional String |
| `videoScript` | `videoScript` | Optional String |
| `image` | `image` | Optional String |
| `videoUrl` | `videoUrl` | Optional String |
| `audioUrl` | `audioUrl` | Optional String |
| `userId` | `userId` | Clerk ID (String) |
| `categoryId` (UUID) | `categoryId` | `Id<"pluginCategories">` |
| `pluginTypeId` (UUID) | `pluginTypeId` | `Id<"pluginTypes">` |
| `optInFormUrl` | `optInFormUrl` | Optional String |
| `price` | `price` | Optional Number |
| `pricingType` (Enum) | `pricingType` | Union: "FREE" \| "PAID" \| "FREEMIUM" |
| `purchaseUrl` | `purchaseUrl` | Optional String |
| `createdAt` (DateTime) | `createdAt` | Number (Unix timestamp) |
| `updatedAt` (DateTime) | `updatedAt` | Number (Unix timestamp) |
| N/A | `isPublished` | Boolean (new field for marketplace visibility) |

---

## üìä Step 1: Export Data from Planetscale

### Option A: Using Prisma Studio

1. Install Prisma globally if not already installed:
```bash
npm install -g prisma
```

2. Open Prisma Studio:
```bash
prisma studio
```

3. Manually export data to JSON files (copy/paste or use browser tools)

### Option B: Using Prisma Client (Recommended)

Create a script `scripts/export-plugins.ts`:

```typescript
import { PrismaClient } from '@prisma/client';
import * as fs from 'fs';

const prisma = new PrismaClient();

async function exportPluginData() {
  try {
    console.log('üîÑ Exporting plugin data from Planetscale...');

    // Export plugin types
    const pluginTypes = await prisma.pluginType.findMany();
    console.log(`‚úÖ Found ${pluginTypes.length} plugin types`);

    // Export plugin categories
    const pluginCategories = await prisma.pluginCategory.findMany();
    console.log(`‚úÖ Found ${pluginCategories.length} plugin categories`);

    // Export effect categories
    const effectCategories = await prisma.pluginEffectCategory.findMany();
    console.log(`‚úÖ Found ${effectCategories.length} effect categories`);

    // Export instrument categories
    const instrumentCategories = await prisma.pluginInstrumentCategory.findMany();
    console.log(`‚úÖ Found ${instrumentCategories.length} instrument categories`);

    // Export studio tool categories
    const studioToolCategories = await prisma.pluginStudioToolCategory.findMany();
    console.log(`‚úÖ Found ${studioToolCategories.length} studio tool categories`);

    // Export plugins
    const plugins = await prisma.plugin.findMany({
      include: {
        category: true,
        pluginType: true,
      },
    });
    console.log(`‚úÖ Found ${plugins.length} plugins`);

    // Save to JSON files
    const exportData = {
      pluginTypes,
      pluginCategories,
      effectCategories,
      instrumentCategories,
      studioToolCategories,
      plugins,
      exportDate: new Date().toISOString(),
    };

    fs.writeFileSync(
      'plugin-export.json',
      JSON.stringify(exportData, null, 2)
    );

    console.log('‚úÖ Export complete! Data saved to plugin-export.json');
    console.log('\nüìä Export Summary:');
    console.log(`   Plugin Types: ${pluginTypes.length}`);
    console.log(`   Plugin Categories: ${pluginCategories.length}`);
    console.log(`   Effect Categories: ${effectCategories.length}`);
    console.log(`   Instrument Categories: ${instrumentCategories.length}`);
    console.log(`   Studio Tool Categories: ${studioToolCategories.length}`);
    console.log(`   Plugins: ${plugins.length}`);
  } catch (error) {
    console.error('‚ùå Export failed:', error);
  } finally {
    await prisma.$disconnect();
  }
}

exportPluginData();
```

Run the export script:
```bash
npx ts-node scripts/export-plugins.ts
```

### Option C: Direct Database Export

```bash
# Export to CSV
pscale db dump <database-name> <branch-name> --output plugin-dump/

# Or export specific tables
pscale db dump <database-name> <branch-name> --tables Plugin,PluginType,PluginCategory --output plugin-dump/
```

---

## üöÄ Step 2: Import Data to Convex

Create an import action in `convex/migrations/importPlugins.ts`:

```typescript
"use node";

import { action } from "../_generated/server";
import { v } from "convex/values";
import { api } from "../_generated/api";

export const importPluginsFromJSON = action({
  args: {
    clerkId: v.string(), // Admin user performing import
    jsonData: v.string(), // JSON string of exported data
  },
  handler: async (ctx, args) => {
    const data = JSON.parse(args.jsonData);
    
    console.log("Starting plugin data import...");
    
    // Track mapping from old UUIDs to new Convex IDs
    const typeIdMap = new Map<string, string>();
    const categoryIdMap = new Map<string, string>();
    
    // 1. Import Plugin Types
    console.log(`Importing ${data.pluginTypes.length} plugin types...`);
    for (const type of data.pluginTypes) {
      const newId = await ctx.runMutation(api.plugins.createPluginType, {
        clerkId: args.clerkId,
        name: type.name,
      });
      typeIdMap.set(type.id, newId);
    }
    
    // 2. Import Plugin Categories
    console.log(`Importing ${data.pluginCategories.length} plugin categories...`);
    for (const category of data.pluginCategories) {
      const newId = await ctx.runMutation(api.plugins.createPluginCategory, {
        clerkId: args.clerkId,
        name: category.name,
      });
      categoryIdMap.set(category.id, newId);
    }
    
    // 3. Import Plugins
    console.log(`Importing ${data.plugins.length} plugins...`);
    let successCount = 0;
    let errorCount = 0;
    
    for (const plugin of data.plugins) {
      try {
        await ctx.runMutation(api.plugins.createPlugin, {
          clerkId: args.clerkId,
          name: plugin.name,
          slug: plugin.slug || undefined,
          author: plugin.author || undefined,
          description: plugin.description || undefined,
          videoScript: plugin.videoScript || undefined,
          image: plugin.image || undefined,
          videoUrl: plugin.videoUrl || undefined,
          audioUrl: plugin.audioUrl || undefined,
          categoryId: plugin.categoryId ? categoryIdMap.get(plugin.categoryId) : undefined,
          pluginTypeId: plugin.pluginTypeId ? typeIdMap.get(plugin.pluginTypeId) : undefined,
          optInFormUrl: plugin.optInFormUrl || undefined,
          price: plugin.price || undefined,
          pricingType: plugin.pricingType as "FREE" | "PAID" | "FREEMIUM",
          purchaseUrl: plugin.purchaseUrl || undefined,
          isPublished: true, // Publish all imported plugins by default
        });
        successCount++;
      } catch (error: any) {
        console.error(`Failed to import plugin ${plugin.name}:`, error.message);
        errorCount++;
      }
    }
    
    console.log("Import complete!");
    return {
      success: true,
      stats: {
        pluginTypes: typeIdMap.size,
        pluginCategories: categoryIdMap.size,
        pluginsSuccess: successCount,
        pluginsError: errorCount,
      },
    };
  },
});
```

---

## üîß Step 3: Run the Migration

### Option A: Using the Convex Dashboard

1. Go to your Convex dashboard: https://dashboard.convex.dev
2. Navigate to "Functions" ‚Üí "Actions"
3. Find `migrations/importPlugins:importPluginsFromJSON`
4. Click "Run"
5. Paste your JSON data from `plugin-export.json`
6. Add your admin Clerk ID
7. Execute the action

### Option B: Using a Script

Create `scripts/import-plugins.ts`:

```typescript
import { ConvexHttpClient } from "convex/browser";
import * as fs from "fs";

const client = new ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL!);

async function importPlugins() {
  const jsonData = fs.readFileSync("plugin-export.json", "utf-8");
  
  const result = await client.action("migrations/importPlugins:importPluginsFromJSON", {
    clerkId: "YOUR_ADMIN_CLERK_ID", // Replace with your Clerk ID
    jsonData,
  });

  console.log("Import result:", result);
}

importPlugins();
```

Run:
```bash
npx ts-node scripts/import-plugins.ts
```

---

## ‚úÖ Step 4: Verify the Migration

### Check Data in Convex Dashboard

1. Go to https://dashboard.convex.dev
2. Navigate to your project
3. Click "Data" in the sidebar
4. Verify tables:
   - `pluginTypes`
   - `pluginCategories`
   - `plugins`

### Test Admin Panel

1. Navigate to `/admin/plugins`
2. Verify all plugins are listed
3. Try editing a plugin
4. Try creating a new plugin

### Test Marketplace

1. Navigate to `/marketplace/plugins`
2. Verify plugins are displayed
3. Test search and filters
4. Click on plugin links

---

## üßπ Step 5: Clean Up Old Data (Optional)

Once you've verified the migration is successful, you can:

1. **Keep Planetscale as backup**: Leave data in Planetscale for reference
2. **Archive and delete**: Export final backup, then delete Planetscale database
3. **Decommission Prisma**: Remove Prisma from your project

```bash
# Remove Prisma dependencies (optional)
npm uninstall prisma @prisma/client

# Remove Prisma files
rm -rf prisma/
rm prisma/schema.prisma
```

---

## üîÑ Incremental Migration (Alternative Approach)

If you want to migrate gradually:

### 1. Export a subset of data
```typescript
// Export only 10 plugins for testing
const plugins = await prisma.plugin.findMany({
  take: 10,
  include: { category: true, pluginType: true },
});
```

### 2. Import and verify
```bash
npx ts-node scripts/import-plugins.ts
```

### 3. Compare records
- Check data accuracy
- Verify relationships
- Test functionality

### 4. Repeat until all data is migrated

---

## ‚ö†Ô∏è Common Issues & Solutions

### Issue 1: Slug Conflicts
**Error**: "A plugin with this slug already exists"

**Solution**: 
- Ensure slugs are unique in your export data
- Or let Convex auto-generate slugs by omitting the slug field

### Issue 2: Missing Relationships
**Error**: "Category not found"

**Solution**:
- Import categories and types BEFORE plugins
- Ensure ID mapping is correct

### Issue 3: Date Format Issues
**Error**: Invalid timestamp

**Solution**:
```typescript
// Convert Prisma DateTime to Unix timestamp
const timestamp = new Date(plugin.createdAt).getTime();
```

### Issue 4: Enum Value Mismatch
**Error**: "Invalid pricingType value"

**Solution**:
- Ensure pricingType is exactly "FREE", "PAID", or "FREEMIUM"
- Convert Prisma enum to Convex union type

---

## üìä Validation Checklist

After migration, verify:

- [ ] All plugin types imported
- [ ] All plugin categories imported  
- [ ] All plugins imported
- [ ] Relationships (category, type) are correct
- [ ] Images/media URLs are accessible
- [ ] Purchase URLs work
- [ ] Pricing information is accurate
- [ ] Admin can create/edit/delete plugins
- [ ] Marketplace displays plugins correctly
- [ ] Search and filters work
- [ ] No duplicate slugs

---

## üéØ Next Steps

1. **Test thoroughly** on a development Convex deployment first
2. **Backup your Planetscale data** before final migration
3. **Monitor for issues** after migration
4. **Update any external references** to plugin IDs
5. **Decommission Prisma/Planetscale** when confident

---

## üÜò Need Help?

If you encounter issues:

1. Check Convex logs in the dashboard
2. Verify your JSON export structure
3. Ensure admin permissions are set correctly
4. Test with a small dataset first
5. Contact Convex support or check their Discord

---

## üìö Additional Resources

- [Convex Documentation](https://docs.convex.dev)
- [Convex Schema Guide](https://docs.convex.dev/database/schemas)
- [Convex Migrations](https://docs.convex.dev/database/migrations)
- [Planetscale Export Guide](https://planetscale.com/docs/imports/database-exports)

---

**Migration Date**: 2025-11-04  
**Version**: 1.0.0

