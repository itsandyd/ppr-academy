# Stripe Connect Local Development Setup Guide

## ðŸŽ¯ Overview

This guide explains exactly where to find each Stripe environment variable and how to set up local webhook testing for the course marketplace.

## ðŸ”‘ Required Environment Variables

Add these to your `.env.local` file:

```env
# Stripe API Keys (from Stripe Dashboard)
STRIPE_SECRET_KEY=sk_test_...
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_...

# Stripe Connect (from Stripe Connect Settings)
STRIPE_CONNECT_CLIENT_ID=ca_...

# Local Development
STRIPE_WEBHOOK_SECRET=whsec_... # Generated by Stripe CLI
NEXT_PUBLIC_APP_URL=http://localhost:3001

# Stripe CLI (for local webhooks)
STRIPE_CLI_DEVICE_NAME=your-device-name
```

## ðŸ“ Where to Find Each Variable

### 1. **STRIPE_SECRET_KEY** & **NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY**

**Location**: Stripe Dashboard â†’ Developers â†’ API keys

**Steps**:
1. Go to [https://dashboard.stripe.com](https://dashboard.stripe.com)
2. Click **"Developers"** in left sidebar
3. Click **"API keys"**
4. Copy both keys:
   - **Secret key**: `sk_test_...` (keep this secret, server-side only)
   - **Publishable key**: `pk_test_...` (safe for client-side use)

**Screenshot Reference**:
```
Dashboard > Developers > API keys
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Publishable key: pk_test_...        â”‚
â”‚ Secret key: sk_test_... [Reveal]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. **STRIPE_CONNECT_CLIENT_ID**

**Location**: Stripe Dashboard â†’ Connect â†’ Settings â†’ Platform profile

**Steps**:
1. Go to [https://dashboard.stripe.com](https://dashboard.stripe.com)
2. Click **"Connect"** in left sidebar (you're already here!)
3. Scroll down to **"Manage platform profile"** section
4. Click **"Platform profile"** 
5. Look for **"Client ID"** in the platform profile settings
6. Copy the value: `ca_...`

**Alternative Location**:
If you don't see it in Platform profile, try:
1. Go to **Connect** â†’ **Settings** (main settings page)
2. Look for **"Integration"** or **"API"** section
3. The Client ID should be displayed as `ca_...`

**What it looks like**:
```
Platform profile
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client ID: ca_1234567890abcdef...    â”‚
â”‚ Used for OAuth flows and redirects  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Note**: If you can't find the Client ID, it might be because Connect needs to be fully configured first. You may need to complete the initial Connect setup wizard.

### 3. **STRIPE_WEBHOOK_SECRET** (Local Development)

**This is generated by the Stripe CLI for local testing**

**Steps**:
1. **Install Stripe CLI** (if not already installed):
   ```bash
   # macOS with Homebrew
   brew install stripe/stripe-cli/stripe
   
   # Or download from: https://github.com/stripe/stripe-cli/releases
   ```

2. **Login to Stripe CLI**:
   ```bash
   stripe login
   ```
   This opens your browser to authenticate.

3. **Start local webhook listener**:
   ```bash
   stripe listen --forward-to localhost:3001/api/webhooks/stripe
   ```
   
4. **Copy the webhook secret** from the CLI output:
   ```bash
   > Ready! Your webhook signing secret is whsec_1234567890abcdef...
   ```
   
5. **Add to .env.local**:
   ```env
   STRIPE_WEBHOOK_SECRET=whsec_1234567890abcdef...
   ```

## ðŸ”§ Local Development Workflow

### **Terminal Setup (Run these in separate terminals)**

**Terminal 1**: Next.js Development Server
```bash
npm run dev
```

**Terminal 2**: Convex Development Server
```bash
# This is already running in your npm run dev script
# But if you need it separately:
npx convex dev
```

**Terminal 3**: Stripe CLI Webhook Listener
```bash
stripe listen --forward-to localhost:3001/api/webhooks/stripe
```

### **Webhook Events You'll Need**

For the course marketplace, you'll want to listen for these events:
```bash
# Listen for Connect account events
stripe listen --events account.updated,account.application.authorized

# Listen for payment events  
stripe listen --events payment_intent.succeeded,payment_intent.payment_failed

# Listen for all events (for development)
stripe listen --forward-to localhost:3001/api/webhooks/stripe
```

## ðŸ—ï¸ Webhook Handler Implementation

Create the webhook handler at `/app/api/webhooks/stripe/route.ts`:

```typescript
import { NextRequest, NextResponse } from "next/server";
import Stripe from "stripe";
import { headers } from "next/headers";

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: "2024-12-18.acacia",
});

const webhookSecret = process.env.STRIPE_WEBHOOK_SECRET!;

export async function POST(request: NextRequest) {
  const body = await request.text();
  const signature = headers().get("stripe-signature")!;

  let event: Stripe.Event;

  try {
    event = stripe.webhooks.constructEvent(body, signature, webhookSecret);
  } catch (err) {
    console.error("âŒ Webhook signature verification failed:", err);
    return NextResponse.json({ error: "Invalid signature" }, { status: 400 });
  }

  console.log("âœ… Stripe webhook received:", event.type);

  try {
    switch (event.type) {
      case "account.updated":
        // Handle Connect account updates
        const account = event.data.object as Stripe.Account;
        console.log("Account updated:", account.id, account.details_submitted);
        // TODO: Update user record with account status
        break;

      case "payment_intent.succeeded":
        // Handle successful course purchases
        const paymentIntent = event.data.object as Stripe.PaymentIntent;
        console.log("Payment succeeded:", paymentIntent.id);
        // TODO: Create course enrollment
        break;

      case "payment_intent.payment_failed":
        // Handle failed payments
        const failedPayment = event.data.object as Stripe.PaymentIntent;
        console.log("Payment failed:", failedPayment.id);
        // TODO: Handle payment failure
        break;

      default:
        console.log("Unhandled event type:", event.type);
    }

    return NextResponse.json({ received: true });
  } catch (error) {
    console.error("âŒ Webhook handler error:", error);
    return NextResponse.json({ error: "Webhook handler failed" }, { status: 500 });
  }
}
```

## ðŸ§ª Testing Your Setup

### **1. Test API Keys**
```bash
# Test your secret key
curl https://api.stripe.com/v1/balance \
  -u sk_test_your_key_here:

# Should return your account balance
```

### **2. Test Connect Client ID**
```bash
# Test Connect account creation
curl -X POST https://api.stripe.com/v1/accounts \
  -u sk_test_your_key_here: \
  -d type=express \
  -d email=test@example.com
```

### **3. Test Webhook Setup**
1. Start your Next.js app: `npm run dev`
2. Start Stripe CLI listener: `stripe listen --forward-to localhost:3001/api/webhooks/stripe`
3. Trigger a test event: `stripe trigger payment_intent.succeeded`
4. Check your app logs for webhook receipt

## ðŸ”’ Security Best Practices

### **Environment Variables**
- âœ… **Never commit** `.env.local` to git
- âœ… **Use test keys** for development (`sk_test_`, `pk_test_`)
- âœ… **Rotate keys** if accidentally exposed
- âœ… **Use live keys** only in production

### **Webhook Security**
- âœ… **Always verify** webhook signatures
- âœ… **Use HTTPS** in production
- âœ… **Implement idempotency** for webhook handlers
- âœ… **Log webhook events** for debugging

## ðŸš€ Complete .env.local Template

```env
# Existing variables (keep these)
NEXT_PUBLIC_CONVEX_URL=https://fastidious-snake-859.convex.cloud
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...
OPENAI_API_KEY=sk-proj-...
RESEND_API_KEY=re_...
UPLOADTHING_TOKEN=...
CONVEX_DEPLOYMENT=dev:fastidious-snake-859

# Add these Stripe variables
STRIPE_SECRET_KEY=sk_test_... # From Dashboard > Developers > API keys
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_... # From Dashboard > Developers > API keys
STRIPE_CONNECT_CLIENT_ID=ca_... # From Dashboard > Connect > Settings
STRIPE_WEBHOOK_SECRET=whsec_... # Generated by `stripe listen`
NEXT_PUBLIC_APP_URL=http://localhost:3001
```

## ðŸ“‹ Setup Checklist

### **Stripe Dashboard Setup**
- [ ] Create Stripe account (if not already done)
- [ ] Switch to **Test mode** for development
- [ ] Copy **API keys** from Developers â†’ API keys
- [ ] Enable **Connect** from Connect â†’ Settings
- [ ] Copy **Connect Client ID**

### **Local Development Setup**
- [ ] Install **Stripe CLI**: `brew install stripe/stripe-cli/stripe`
- [ ] Login to CLI: `stripe login`
- [ ] Add **environment variables** to `.env.local`
- [ ] Create **webhook handler** at `/api/webhooks/stripe/route.ts`
- [ ] Start **webhook listener**: `stripe listen --forward-to localhost:3001/api/webhooks/stripe`

### **Test the Integration**
- [ ] Navigate to `/store/{storeId}/settings/payouts`
- [ ] Click **"Connect Stripe Account"**
- [ ] Complete Stripe Express onboarding
- [ ] Verify account status shows as **"Active"**
- [ ] Test webhook events with `stripe trigger`

## ðŸŽ¯ Next Steps After Setup

Once your Stripe Connect is working:

1. **Test Course Creator Onboarding**
   - Go to Payouts settings
   - Connect your Stripe account
   - Complete verification process

2. **Implement Course Payments**
   - Update course enrollment form
   - Add Stripe Elements for payment
   - Handle payment success/failure

3. **Add Enrollment Management**
   - Create course access after payment
   - Send enrollment confirmations
   - Track student progress

---

## ðŸ†˜ Troubleshooting

### **Common Issues**

**"Invalid API Key"**
- Check that you're using test keys (`sk_test_`, `pk_test_`)
- Verify keys are correctly copied (no extra spaces)

**"Connect Client ID not found"**
- Ensure Connect is enabled in your Stripe dashboard
- Check Dashboard â†’ Connect â†’ Settings for the Client ID

**"Webhook signature verification failed"**
- Restart `stripe listen` to get a fresh webhook secret
- Copy the new `whsec_...` value to your `.env.local`
- Restart your Next.js development server

**"Account creation failed"**
- Check your API keys are correct
- Verify Connect is enabled in your Stripe account
- Check the browser console and server logs for detailed errors

---

*This guide covers everything you need to get Stripe Connect running locally for course marketplace development!*
